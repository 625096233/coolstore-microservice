#!/bin/bash
echo "Fixing web.xml to ${AUTH_URL}"
sed -i -e "s|##SSO_AUTH_URL##|${AUTH_URL}|" /tmp/src/src/main/webapp/WEB-INF/keycloak.json

echo "Running decisionserver assemble"
/usr/local/s2i/assemble

echo "Running Cool Microservice assemble"

cd ${JBOSS_HOME}
curl -q 'http://downloads.jboss.org/keycloak/1.9.4.Final/adapters/keycloak-oidc/keycloak-eap6-adapter-dist-1.9.4.Final.tar.gz' | tar -xzv

# Standalone.xml modifications.
sed -i -e 's/<extensions>/&\n        <extension module="org.keycloak.keycloak-adapter-subsystem"\/>/' $JBOSS_HOME/standalone/configuration/standalone-openshift.xml
sed -i -e 's/<profile>/&\n        <subsystem xmlns="urn:jboss:domain:keycloak:1.1"\/>/' $JBOSS_HOME/standalone/configuration/standalone-openshift.xml
sed -i -e 's/<security-domains>/&\n                <security-domain name="keycloak">\n                    <authentication>\n                        <login-module code="org.keycloak.adapters.jboss.KeycloakLoginModule" flag="required"\/>\n                    <\/authentication>\n                <\/security-domain>/' $JBOSS_HOME/standalone/configuration/standalone-openshift.xml

